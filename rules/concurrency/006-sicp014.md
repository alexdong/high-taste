# Use message queues, async or immutable data structures to coordinate concurrent processes rather than locking shared variables.

**ID**: SICP014  
**Category**: Concurrency (Avoid Shared Mutable State) â†’ concurrency

## Rule Description
Use message queues, async or immutable data structures to coordinate concurrent processes rather than locking shared variables.

## Before
```python
import threading
counter = 0

def worker():
    global counter
    for _ in range(10000):
        counter += 1

threads = [threading.Thread(target=worker) for _ in range(5)]
for t in threads: t.start()
for t in threads: t.join()
print(counter)
```

## After  
```python
import asyncio, collections

async def worker(q: asyncio.Queue):
    while True:
        item = await q.get()
        if item is None:  # poison pill
            q.task_done()
            break
        # process item
        q.task_done()

async def main():
    q = asyncio.Queue()
    producers = [q.put(i) for i in range(10000)] + [q.put(None) for _ in range(5)]
    consumers = [asyncio.create_task(worker(q)) for _ in range(5)]
    await asyncio.gather(*producers)
    await q.join()
    for c in consumers:
        await c

asyncio.run(main())
```

## Full Example
```python
# uses asyncio Queue, avoids shared counter
```
